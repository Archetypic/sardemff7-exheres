# Copyright 2011 Quentin "Sardem FF7" Glidic <sardemff7+exherbo@sardemff7.net>
# Distributed under the terms of the GNU General Public License v2
# Based in part upon
#     nspr-9999.ebuild from Gentoo sardemff7 overlay, which is:
#         Copyright 1999-2011 Gentoo Foundation
# and
#     nspr.exlib from Exherbo desktop overlay, which is:
#         Copyright 2008, 2009 Ingmar Vanhassel <ingmar@exherbo.org>

require mozilla-scm autotools [ supported_autoconf=[ 2.1 ] supported_automake=[ none ] ]


SLOT="0"

HOMEPAGE="http://www.mozilla.org/projects/nspr/"

SUMMARY="Netscape Portable Runtime"

PLATFORMS="~amd64"

MYOPTIONS="
    debug

    platform: amd64
"


ECONF_SOURCE="${WORK}/nsprpub/"
WORK="${WORKBASE}/build"

DEFAULT_SRC_COMPILE_PARAMS=(
    CC="${CC}"
    CXX="${CXX}"
)

src_unpack() {
    scm_src_unpack
    edo mkdir -p "${WORK}"
    edo cp \
        "${FILES}"/nspr.pc.in \
        "${FILES}"/Makefile-pc \
        "${WORK}"
}

src_prepare() {
    edo cd "${ECONF_SOURCE}"
    default

    #epatch "${FILESDIR}"/${PN}-4.7.0-prtime.patch
    #epatch "${FILESDIR}"/libs.patch

    edo sed -i -e 's/perl5//g' configure

    eautoconf
}

src_configure() {
    # Respect LDFLAGS
    export DSO_LDOPTS="${LDFLAGS}"

    econf \
        --hates=docdir \
        --enable-system-sqlite \
        $(option_enable debug) \
        $(option_enable platform:amd64 64bit) \
        $(option_enable debug) \
        $(option_enable !debug optimize) \
        --libdir=/usr/${LIBDIR}
}

src_compile() {
    default
    emake -f Makefile-pc nspr.pc
}

src_test() {
    edo perl "${ECONF_SOURCE}"/pr/tests/runtests.pl
}

src_install() {
    default
    emake -f Makefile-pc DESTDIR="${IMAGE}" install_nspr.pc

    emake -f Makefile-pc echo-minor | read MINOR

    cd "${IMAGE}"/usr/${LIBDIR}
    local file n=
    for file in *.so; do
        n=${file}.${MINOR}
        edo mv ${file} ${n}
        edo ln -s ${n} ${file}
    done

    # Remove stupid files in /usr/bin
    edo rm "${IMAGE}"/usr/bin/{compile-et.pl,prerr.properties}
}
